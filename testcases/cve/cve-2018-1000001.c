// SPDX-License-Identifier: GPL-2.0-or-later
/*
 * Copyright (C) 2018 Petr Vorel <pvorel@suse.cz>
 *
 * Idea based on glibc source io/tst-getcwd-abspath.c, contributed by
 * Dmitry V. Levin
 * https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=commitdiff;h=52a713fdd0a30e1bd79818e2e3c4ab44ddca1a94;hp=249a5895f120b13290a372a49bb4b499e749806f
 */

#include "tst_test.h"

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#define CHROOT_DIR "cve-2018-1000001"

static void setup(void)
{
	SAFE_MKDIR(CHROOT_DIR, 0755);
	SAFE_CHROOT(CHROOT_DIR);
}

static void run(unsigned int i)
{
	int fail = 0;

	errno = 0;

	if (!i) {
		tst_res(TINFO, "testing getcwd()");
		TESTPTR(getcwd(NULL, 0));
	} else {
		tst_res(TINFO, "testing realpath()");
		TESTPTR(realpath(".", NULL));
	}

	if (errno != ENOENT) {
		tst_res(TFAIL | TERRNO, "returned unexpected errno");
		fail = 1;
	}

	if (TEST_RETURN_PTR != NULL) {
		tst_res(TFAIL, "syscall didn't return NULL: '%s'",
				(char *)TEST_RETURN_PTR);
		fail = 1;
	}

	if (!fail)
		tst_res(TPASS, "bug not reproduced");
}

static struct tst_test test = {
	.test = run,
	.tcnt = 2,
	.setup = setup,
	.needs_root = 1,
	.needs_tmpdir = 1,
};
